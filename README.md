# MyDockerï¼š ä¸€ä¸ªç”¨ C++ å®žçŽ°çš„æžç®€å®¹å™¨å¼•æ“Ž
æ¬¢è¿Žæ¥åˆ° **MyDocker**ï¼Œè¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ C++ ä»Žé›¶å¼€å§‹æž„å»ºä¸€ä¸ªç®€å•è€ŒåŠŸèƒ½é½å…¨çš„å®¹å™¨è¿è¡Œæ—¶çš„å®žè·µé¡¹ç›®ã€‚æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡å¯“æ•™äºŽä¹çš„æ–¹å¼ï¼Œæ­å¼€å½“æ‚¨è¾“å…¥ `docker run` æ—¶åº•å±‚å‘ç”Ÿçš„ä¸€åˆ‡çš„ç¥žç§˜é¢çº±ã€‚

## ðŸŒŸ æ¨¡æ‹Ÿå®žçŽ°çš„æ ¸å¿ƒ Docker åŠŸèƒ½
æœ¬é¡¹ç›®å¹¶éžè¦å–ä»£ Dockerï¼Œè€Œæ˜¯ä¸“æ³¨äºŽæ¨¡æ‹Ÿå®žçŽ°å®¹å™¨åŒ–æŠ€æœ¯çš„æ ¸å¿ƒæœºåˆ¶ã€‚æˆ‘ä»¬å·²ç»æˆåŠŸå®žçŽ°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

1.  **å‘½åç©ºé—´ (Namespaces) - å®žçŽ°éš”ç¦»**
    *   **PID å‘½åç©ºé—´ (`CLONE_NEWPID`):** å®¹å™¨æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„è¿›ç¨‹æ ‘ï¼Œèµ·å§‹è¿›ç¨‹çš„ PID ä¸º 1ã€‚åœ¨å®¹å™¨å†…éƒ¨ï¼Œæ‚¨åªèƒ½çœ‹åˆ°å±žäºŽå®ƒè‡ªå·±çš„è¿›ç¨‹ã€‚
    *   **æŒ‚è½½å‘½åç©ºé—´ (`CLONE_NEWNS`):** æ¯ä¸ªå®¹å™¨éƒ½èŽ·å¾—ä¸€ä¸ªéš”ç¦»çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚æˆ‘ä»¬é€šè¿‡ `pivot_root` ç³»ç»Ÿè°ƒç”¨å’ŒæŒ‚è½½ä¸€ä¸ªä¸“ç”¨çš„ `/proc` æ–‡ä»¶ç³»ç»Ÿæ¥å®žçŽ°è¿™ä¸€ç‚¹ã€‚
    *   **UTS å‘½åç©ºé—´ (`CLONE_NEWUTS`):** å…è®¸æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸»æœºåã€‚
    *   **ç½‘ç»œå‘½åç©ºé—´ (`CLONE_NEWNET`):** æä¾›ç½‘ç»œéš”ç¦»ã€‚æˆ‘ä»¬ä½¿ç”¨ **`slirp4netns`** æ¥æ¨¡æ‹Ÿæ— æ ¹æ¨¡å¼ï¼ˆrootlessï¼‰çš„ç½‘ç»œï¼Œä½¿å®¹å™¨èƒ½å¤Ÿè®¿é—®äº’è”ç½‘ï¼Œè€Œæ— éœ€ root æƒé™æ¥é…ç½®ç½‘ç»œã€‚
    *   **ç”¨æˆ·å‘½åç©ºé—´ (`CLONE_NEWUSER`):** å°†å®¹å™¨å†…çš„ root ç”¨æˆ· (UID 0) æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªéžç‰¹æƒç”¨æˆ·ï¼Œä»Žè€Œæ˜¾è‘—å¢žå¼ºå®‰å…¨æ€§ã€‚è¿™æ˜¯â€œæ— æ ¹å®¹å™¨â€æŠ€æœ¯çš„åŸºç¡€ã€‚

2.  **æŽ§åˆ¶ç»„ (Cgroups) - å®žçŽ°èµ„æºé™åˆ¶**
    *   æˆ‘ä»¬åˆ©ç”¨ **æŽ§åˆ¶ç»„ (v2)** æ¥å¯¹å®¹å™¨å®žæ–½èµ„æºçº¦æŸã€‚
    *   **å†…å­˜é™åˆ¶:** é™åˆ¶å®¹å™¨åªèƒ½ä½¿ç”¨ç‰¹å®šæ•°é‡çš„å†…å­˜ï¼ˆä¾‹å¦‚ 100MBï¼‰ã€‚
    *   **CPU é™åˆ¶:** å°†å®¹å™¨çš„ CPU ä½¿ç”¨çŽ‡é™åˆ¶åœ¨ä¸€ä¸ªé¢„å®šä¹‰çš„é…é¢å†…ï¼ˆä¾‹å¦‚ä¸€ä¸ª CPU æ ¸å¿ƒçš„ 50%ï¼‰ã€‚

3.  **å®¢æˆ·ç«¯-æœåŠ¡å™¨æž¶æž„**
    *   æœ¬é¡¹ç›®æ¨¡ä»¿äº† Docker çš„ `dockerd` (å®ˆæŠ¤è¿›ç¨‹) å’Œ `docker` (å®¢æˆ·ç«¯) æ¨¡åž‹ã€‚
    *   **å®ˆæŠ¤è¿›ç¨‹ (`sudo ./my-docker`):** ä¸€ä¸ªä»¥ root æƒé™è¿è¡Œçš„åŽå°è¿›ç¨‹ï¼Œè´Ÿè´£ç®¡ç†å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚å®ƒé€šè¿‡ä¸€ä¸ª Unix åŸŸå¥—æŽ¥å­— (`/var/run/my-docker.sock`) ç›‘å¬å‘½ä»¤ã€‚
    *   **å®¢æˆ·ç«¯ (`./my-docker run ...`):** ä¸€ä¸ªéžç‰¹æƒçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒä¸Žå®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œä»¥åˆ›å»ºå®¹å™¨å¹¶ä¸Žä¹‹äº¤äº’ã€‚

4.  **äº¤äº’å¼ TTY (ä¼ªç»ˆç«¯)**
    *   æˆ‘ä»¬ä¸ºå®¹å™¨å®žçŽ°äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„äº¤äº’å¼ä¼ªç»ˆç«¯ (PTY)ã€‚
    *   è¿™æä¾›äº†çœŸå®žçš„äº¤äº’å¼ Shell ä½“éªŒï¼Œæ”¯æŒå‘½ä»¤åŽ†å²ã€è¡Œç¼–è¾‘ï¼Œå¹¶èƒ½è¿è¡Œå¦‚ `vim` å’Œ `top` è¿™æ ·çš„å…¨å±åº”ç”¨ç¨‹åºã€‚
    *   æˆ‘ä»¬ä½¿ç”¨ `poll()` åœ¨å®¢æˆ·ç«¯çš„ç»ˆç«¯å’Œå®¹å™¨çš„ PTY ä¹‹é—´è¿›è¡ŒåŒå‘çš„ I/O è½¬å‘ã€‚

5.  **æ–‡ä»¶ç³»ç»Ÿåˆ†å±‚ (æ¦‚å¿µæ€§å®žçŽ°)**
    *   è™½ç„¶æ²¡æœ‰å®Œæ•´å®žçŽ°åƒ OverlayFS è¿™æ ·çš„è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œä½†æœ¬é¡¹ç›®ä½¿ç”¨äº†ä¸€ä¸ªé¢„å…ˆå‡†å¤‡å¥½çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ (`rootfs`) ç›®å½•ã€‚è¿™æ¨¡æ‹Ÿäº†å®¹å™¨é•œåƒæ–‡ä»¶ç³»ç»Ÿå±‚çš„æ¦‚å¿µï¼Œä¸ºå®¹å™¨æä¾›äº†è‡ªå·±éš”ç¦»çš„æ ¹ç›®å½•ã€‚

## ðŸŽ“ æ•™è‚²ä»·å€¼
MyDocker çš„ä¸»è¦ç›®æ ‡æ˜¯å­¦ä¹ ã€‚é€šè¿‡æž„å»ºè¿™ä¸ªé¡¹ç›®ï¼Œæ‚¨å°†å¯¹ä»¥ä¸‹å†…å®¹èŽ·å¾—æ·±åˆ»ä¸”å®žè·µæ€§çš„ç†è§£ï¼š

*   **Linux ç³»ç»Ÿè°ƒç”¨:** ç›´æŽ¥ä½¿ç”¨ `clone()`, `chroot()`, `mount()`, `sethostname()` ç­‰ã€‚
*   **è¿›ç¨‹ç®¡ç†:** ç†Ÿç»ƒè¿ç”¨ `fork()`, `execvp()`, `waitpid()` å’Œä¿¡å·å¤„ç†ã€‚
*   **è¿›ç¨‹é—´é€šä¿¡ (IPC):** ä½¿ç”¨ Unix åŸŸå¥—æŽ¥å­—è¿›è¡Œ C/S é€šä¿¡ï¼Œä»¥åŠä½¿ç”¨ç®¡é“è¿›è¡Œçˆ¶å­è¿›ç¨‹é—´çš„åŒæ­¥ã€‚
*   **å®¹å™¨æŠ€æœ¯åŸºçŸ³:** ç†è§£å‘½åç©ºé—´å’ŒæŽ§åˆ¶ç»„æ˜¯å¦‚ä½•æˆä¸ºæ‰€æœ‰å®¹å™¨æŠ€æœ¯çš„æ ¹æœ¬æž„å»ºå—ã€‚
*   **é«˜çº§ I/O:** å®žçŽ°åŸºäºŽ `poll()` çš„éžé˜»å¡žåŒå‘ I/O è½¬å‘å’Œç®¡ç†ä¼ªç»ˆç«¯ (`pty`)ã€‚
*   **å®‰å…¨æ¦‚å¿µ:** ç†è§£æœ‰æ ¹å®¹å™¨å’Œæ— æ ¹å®¹å™¨ä¹‹é—´çš„å…³é”®åŒºåˆ«ï¼Œä»¥åŠç”¨æˆ·å‘½åç©ºé—´åœ¨é™ä½Žå®‰å…¨é£Žé™©ä¸­çš„ä½œç”¨ã€‚

## âš ï¸ åŠŸèƒ½é™åˆ¶
è¿™æ˜¯ä¸€ä¸ªæ•™è‚²æ€§é¡¹ç›®ï¼Œç¼ºå°‘è®¸å¤šç”Ÿäº§çº§å®¹å™¨å¼•æ“Žæ‰€å…·å¤‡çš„åŠŸèƒ½ï¼š

*   **æ— é•œåƒç®¡ç†:** æ²¡æœ‰å®¹å™¨é•œåƒã€åˆ†å±‚æˆ–é•œåƒä»“åº“çš„æ¦‚å¿µã€‚`rootfs` å¿…é¡»åœ¨å®¿ä¸»æœºä¸Šæ‰‹åŠ¨å‡†å¤‡ã€‚
*   **æ— è”åˆæ–‡ä»¶ç³»ç»Ÿ:** æ²¡æœ‰ä½¿ç”¨ OverlayFS æˆ–ç±»ä¼¼æŠ€æœ¯ã€‚å®¹å™¨å†…çš„æ›´æ”¹ä¼šç›´æŽ¥å†™å…¥ `rootfs` ç›®å½•ã€‚
*   **ç®€åŒ–çš„ç½‘ç»œ:** è™½ç„¶ `slirp4netns` æä¾›äº†äº’è”ç½‘è®¿é—®ï¼Œä½†ä¸æ”¯æŒåˆ›å»ºå¤æ‚çš„å®¹å™¨ç½‘ç»œã€ç«¯å£æ˜ å°„æˆ– DNS æœåŠ¡ã€‚
*   **æ— æŒä¹…åŒ–å­˜å‚¨:** æ²¡æœ‰å·ç®¡ç†åŠŸèƒ½ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸´æ—¶çš„ã€‚
*   **ç®€åŒ–çš„å‘½ä»¤è¡Œ:** å‘½ä»¤è¡ŒæŽ¥å£ï¼ˆCLIï¼‰éžå¸¸åŸºç¡€ã€‚
*   **å¥å£®æ€§ä¸Žé”™è¯¯å¤„ç†:** é”™è¯¯å¤„ç†æ¯”è¾ƒåŸºç¡€ï¼Œæœªè¾¾åˆ°ç”Ÿäº§çŽ¯å¢ƒè¦æ±‚çš„å¥å£®æ€§ã€‚

## ðŸš€ å¦‚ä½•ä½¿ç”¨

### çŽ¯å¢ƒå‡†å¤‡
*   ä¸€ä¸ª Linux çŽ¯å¢ƒã€‚
*   C++ ç¼–è¯‘å™¨ (`g++`), `make`ã€‚
*   å¿…è¦çš„å·¥å…·: `slirp4netns`ã€‚

### 1. å®‰è£…ä¾èµ–
é¦–å…ˆï¼Œå®‰è£…å¿…è¦çš„ä¾èµ–é¡¹ã€‚
```bash
sudo apt-get update
sudo apt-get install slirp4netns
```

### 2. å‡†å¤‡æ ¹æ–‡ä»¶ç³»ç»Ÿ (`rootfs`)
æ­¤æ­¥éª¤å°†åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬çš„å®¹å™¨å°†ç”¨ä½œå…¶æ ¹ç›®å½•çš„æœ€å°åŒ–æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚
```bash
make build
```

### 3. è®¾ç½®æƒé™ (ç­‰åŒäºŽ Docker ç”¨æˆ·ç»„)
æˆ‘ä»¬çš„å®ˆæŠ¤è¿›ç¨‹éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç”¨æˆ·ç»„ï¼Œä»¥æŽˆæƒéž root ç”¨æˆ·è®¿é—®å…¶å¥—æŽ¥å­—ã€‚
```bash
# åˆ›å»ºä¸€ä¸ªåä¸º 'mydocker' çš„ç”¨æˆ·ç»„
sudo groupadd mydocker
# å°†æ‚¨å½“å‰çš„ç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªç»„
sudo usermod -aG mydocker $USER
# é‡è¦æç¤º: ä¸ºäº†è®©ç”¨æˆ·ç»„çš„æ›´æ”¹ç”Ÿæ•ˆï¼Œæ‚¨å¿…é¡»
# å®Œå…¨é€€å‡ºå½“å‰ä¼šè¯å¹¶é‡æ–°ç™»å½•ï¼Œæˆ–è€…åœ¨ç»ˆç«¯ä¸­è¿è¡Œ 'newgrp mydocker'ã€‚
```

### 4. è¿è¡Œ MyDocker!
æ‚¨éœ€è¦**ä¸¤ä¸ªç»ˆç«¯çª—å£**ã€‚

**åœ¨ç»ˆç«¯ 1 (å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹):**
ä½¿ç”¨ `sudo` è¿è¡Œå®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒå°†å¼€å§‹ç›‘å¬å®¢æˆ·ç«¯è¿žæŽ¥ã€‚
```sh
# sudo ./build/my-docker
make rund
```
```sh
# é¢„æœŸè¾“å‡º:
[Daemon] Starting...
[Daemon] Listening on /var/run/my-docker.sock
```

**åœ¨ç»ˆç«¯ 2 (è¿è¡Œä¸€ä¸ªå®¹å™¨):**
ä»¥**æ™®é€šç”¨æˆ·**èº«ä»½è¿è¡Œå®¢æˆ·ç«¯ã€‚å®ƒå°†è¿žæŽ¥åˆ°å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶åœ¨ä¸€ä¸ªæ–°å®¹å™¨ä¸­å¯åŠ¨ä¸€ä¸ªäº¤äº’å¼ Shellã€‚
```bash
# ./my-docker run /bin/sh
make run
```
```sh
# çŽ°åœ¨æ‚¨åº”è¯¥å·²ç»è¿›å…¥äº†å®¹å™¨çš„ Shellï¼
root@my-container:/# 
```

**åœ¨å®¹å™¨å†…éƒ¨ï¼Œæ‚¨å¯ä»¥éªŒè¯éš”ç¦»æ€§ï¼š**
```bash
# æ£€æŸ¥ PID (åº”è¯¥æ˜¯ 1)
root@my-container:/# echo $$
# æŸ¥çœ‹è¿›ç¨‹ (åº”è¯¥åªèƒ½çœ‹åˆ°å®¹å™¨è‡ªå·±çš„è¿›ç¨‹)
root@my-container:/# ps aux
# æŸ¥çœ‹ä¸»æœºå
root@my-container:/# hostname
# é€€å‡ºå®¹å™¨ Ctrl+D
root@my-container:/# exit
```

è¦åœæ­¢å®ˆæŠ¤è¿›ç¨‹ï¼Œè¯·å›žåˆ°**ç»ˆç«¯ 1** å¹¶æŒ‰ä¸‹ `Ctrl+C`ã€‚

## more details
> check out the **docs**